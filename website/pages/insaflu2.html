<!DOCTYPE html>
<html lang="en">
<head>
    <title>INSaFLU Visualization Frameworks</title>
    <meta charset="utf-8">
    <link href='../style/index.css' rel="stylesheet">
    <link rel="icon" href="../img/logo.png">
    <script src="https://cdn.rawgit.com/phylocanvas/phylocanvas-quickstart/v2.8.1/phylocanvas-quickstart.js"></script>

    <!-- Load d3.js and the geo projection plugin -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

    <!-- Load Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
            integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
            crossorigin=""></script>

    <style>

    </style>

</head>

<body style="min-width: 1700px; margin: auto">

<header>

    <div style="border-style: dashed; border-color: transparent; width: 100%; margin: auto;">
        <div style="border-style: dashed; border-color: transparent; float: left; margin-top: 2%; margin-left: 12.5%">
            <a href="https://ist.pt" target="_blank" rel="noopener noreferrer">
                <img src="../img/ul.png" width="150">
            </a>
        </div>

        <div style="border-style: dashed; border-color: transparent; float: left;margin-top: 1.5%; margin-left: 12.5%">
            <a href="https://ist.pt" target="_blank" rel="noopener noreferrer">
                <img src="../img/ist.jpg" width="130">
            </a>
        </div>

        <div style="border-style: dashed; border-color: transparent; float: right; margin-top: 1.8%; margin-right: 12.5%">
            <a href="https://imm.medicina.ulisboa.pt/pt/" target="_blank" rel="noopener noreferrer">
                <img src="../img/imm.png" width="130">
            </a>
        </div>

        <div style="border-style: dashed; border-color: transparent; float: right;margin-top: 1.5%; margin-right: 12.5%">
            <a href="https://ist.pt" target="_blank" rel="noopener noreferrer">
                <img src="../img/fmul.png" width="130">
            </a>
        </div>

    </div>

    <p style="margin-top: 7%; text-align: center; font-size: 45px;"><a href="../index.html" style="color: black; text-decoration: none">Community Finding in Phylogenetic Networks</a></p>

</header>

<div style="display: block; width: 90%; float: left; margin-right: 50px; margin-left: 75px; margin-top: 50px; border-style: solid; position: relative; padding-bottom: 25px">
    <h2 style="text-align: center; font-size: 30px;">Phylogenetic Trees &#127794;</h2>

    <div id="phylocanvas" style="height: 500px; margin-left: 5%; margin-right: 5%; margin-top: 25px; border-style: solid; overflow: hidden"></div>

            <div class="dropdown" style="position: absolute; left: 0; top: 0;">
                <button id = shape class="dropbtn" style="width: 90px; text-align: center;">Shape</button>
                <div id = "dropdown-content" class="dropdown-content" style="line-height: 18px;">
                    <a id = "Radial" onclick="plot(this.id)" style="cursor: pointer;">Radial</a>
                    <a id = "Rectangular" onclick="plot(this.id)" style="cursor: pointer">Rectangular</a>
                    <a id = "Circular" onclick="plot(this.id)" style="cursor: pointer">Circular</a>
                    <a id = "Diagonal" onclick="plot(this.id)" style="cursor: pointer">Diagonal</a>
                    <a id = "Hierarchical" onclick="plot(this.id)" style="cursor: pointer">Hierarchical</a>
                </div>
            </div>
</div>

<div style="display: block; width: 90%; float: left; margin-right: 50px; margin-left: 75px; margin-top: 50px; margin-bottom: 50px; border-style: solid; padding-bottom: 25px">
    <h2 style="text-align: center; font-size: 30px;">Geographical Map &#127757;</h2>

        <div id="mapid" style="height: 500px; margin-left: 5%; margin-right: 5%; margin-top: 25px; border-style: solid"></div>
</div>

<div class="container2" style="background-color: black; height: 50px; margin: auto">
    <p style="padding-left: 50px"><a href="https://warcraft12321.github.io/LUI/" target="_blank" rel="noopener noreferrer"><img src="../img/luiss.png" width="50px" alt="Luís"></a></p>
    <div id = "socialMedia">
        <a href = "https://www.researchgate.net/profile/Luis_Rita2" target="_blank" rel="noopener noreferrer">
            <img src = "../img/rg.png" width="25" style="margin-right: 5%" alt="ResearchGate">
        </a>
        <a href = "https://www.npmjs.com/~warcraft12321" target="_blank" rel="noopener noreferrer">
            <img src = "../img/npm.png" width="50" style="margin-right: 5%" alt="NPM">
        </a>
        <a href = "https://hub.docker.com/u/warcraft12321" target="_blank" rel="noopener noreferrer">
            <img src = "../img/docker.png" width="35" style="margin-right: 5%" alt="Docker Hub">
        </a>
        <a href = "https://github.com/warcraft12321" target="_blank" rel="noopener noreferrer">
            <img src = "../img/github.png" width="25" style="margin-right: 5%" alt="GitHub">
        </a>
    </div>
</div>

<script>

    // ------------------------------------------ Acquiring Data ------------------------------------------

    let data;

    fetch("/insaflu_tree/").then(function(res) {

        return res.text();

    }).then(function(jsonData) {

        data = jsonData;

        plot("Circular");

    });

    fetch('/insaflu_sample/').then(function(res) {

        return res.json();

    }).then(function(jsonData) {

        phylTree(jsonData);
        geoMap(jsonData);

    });

    // ------------------------------------------ Auxiliary Functions ------------------------------------------

    function hashCode(str) { // java String#hashCode
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        return hash;
    }

    function intToRGB(i){
        let c = (i & 0x00FFFFFF)
            .toString(16)
            .toUpperCase();

        return "00000".substring(0, 6 - c.length) + c;
    }

    function label2number(label, metadata, id) {

        let result = {};

        for (let i = 0; i < Object.keys(metadata).length; i++) {

            result[(metadata[i][label])] = (result[metadata[i][label]] + 1) || 0;
        }
        return result[id]
    }

    // ------------------------------------------ Phylogenetic Tree ------------------------------------------

    let tree = Phylocanvas.createTree('phylocanvas', {

        baseNodeSize: 10,
        padding: 5,
        textSize: 10,
        font: "helvetica",
       // root: "A_H3N2_reference_demo",
        zoomFactor: 2,
        labelPadding: 5,
        showLabels: true,
        lineWidth: 3,
        alignLabels: true,
      //  highlightColour: "red",
        highlightSize: 2
     //   showBranchLengthLabels: true

    });

  //  console.log(getNodeAtMousePosition("hover"));

    /*
        tree.on('click', function (e) {
            var node = tree.getNodeAtMousePosition(e);
            if (node) {
                tree.redrawFromBranch(node);
            } else {
                tree.redrawOriginalTr();
            }
        });
    */
/*
           tree.on('beforeFirstDraw', function () {

              for (let i = 0; i < tree.leaves.length; i++) {

                //  for(let j = 0; j < metaData["influenza_03"].length; j++)

                  tree.leaves[i].data = {
                      column1: {
                          colour: '#3C7383',
                          label: 'Label' + (i + 1),
                      },
                      column2: '#9BB7BF',
                      column3: '#3C7383',
                      column4: '#9BB7BF',
                  };

              }
          });
*/
    function plot (type) {

        document.getElementById("shape").innerText = type;

        tree.load(data);

       // tree.redrawFromBranch(tree.branches["influenza_05"]);

        // Tree - Functions
          tree.setTreeType(type.toLowerCase()); // Choosing type of tree: takes radial, rectangular, circular, diagonal and hierarchy.

        if (type === "Circular" || type === "Radial") {

            for (let i = 0; i < tree.leaves.length; i++) {

                tree.leaves[i].data = {

                };
            }

        }
        tree.draw();
    }

    let active = true;

    function meta() {

        if(!active) {

                for (let i = 0; i < tree.leaves.length; i++) {
                    tree.leaves[i].data = {
                        column1: {
                            colour: '#3C7383',
                            label: 'Label' + (i + 1),
                        },
                        column2: '#9BB7BF',
                        column3: '#3C7383',
                        column4: '#9BB7BF',
                    };
                }

            active = true;

        } else {

            for (let i = 0; i < tree.leaves.length; i++) {
                tree.leaves[i].data = {

                };
            }

            active = false;

        }

        tree.draw();

    }

    function phylTree(metaData) {

        tree.on('beforeFirstDraw', function () {

            //   console.log(Object.keys(metaData["influenza_03"]).length);

            for (let i = 0; i < tree.leaves.length; i++) {

                for (let j = 0; j < Object.keys(Object.values(metaData)[i]).length; j++) {

                    (tree.leaves[i].data)[Object.keys(metaData[Object.keys(metaData)[i]])[j]] = (tree.leaves[i].data)[Object.keys(metaData[Object.keys(metaData)[i]])[j]] || {};

                    (tree.leaves[i].data)[Object.keys(metaData[Object.keys(metaData)[i]])[j]]["colour"] = "#" + intToRGB(hashCode(Object.values(metaData[Object.keys(metaData)[i]])[j]));
                    (tree.leaves[i].data)[Object.keys(metaData[Object.keys(metaData)[i]])[j]]["label"] = Object.values(metaData[Object.keys(metaData)[i]])[j];

                }
            }
        });
    }

    // -------------------------------------- Buttons

    let button1 = document.createElement("BUTTON");
    let button21 = document.createElement("BUTTON");
    let button3 = document.createElement("BUTTON");
    let button4 = document.createElement("BUTTON");
    let button5 = document.createElement("BUTTON");

    let radio = document.createElement("INPUT");

    button1.innerHTML = "Radial";
    button1.style.position = "absolute";
    button1.style.right = "0";
    button1.style.top = "0";
    button1.id = "shape";
    button1.onclick = plot;
    button1.style.zIndex = "1";

    button21.innerHTML = "Rectangular";
    button21.style.position = "absolute";
    button21.style.right = "100px";
    button21.style.top = "0";
    button21.id = "shape";
    button21.onclick = plot;
    button21.style.zIndex = "1";

    button3.innerHTML = "Circular";
    button3.style.position = "absolute";
    button3.style.right = "200px";
    button3.style.top = "0";
    button3.id = "shape";
    button3.onclick = plot;
    button3.style.zIndex = "1";

    button4.innerHTML = "Diagonal";
    button4.style.position = "absolute";
    button4.style.right = "300px";
    button4.style.top = "0";
    button4.id = "shape";
    button4.onclick = plot;
    button4.style.zIndex = "1";

    button5.innerHTML = "Hierarchical";
    button5.style.position = "absolute";
    button5.style.right = "400px";
    button5.style.top = "0";
    button5.id = "shape";
    button5.onclick = plot;
    button5.style.zIndex = "1";

    radio.type = "checkbox";
    radio.onchange = meta;
    radio.checked = "true";
    radio.style.zIndex = "1";
    radio.style.position = "absolute";
    radio.style.right = "100";
    radio.style.top = "0";

    document.getElementById("phylocanvas").appendChild(button1);
    document.getElementById("phylocanvas").appendChild(button21);
    document.getElementById("phylocanvas").appendChild(button3);
    document.getElementById("phylocanvas").appendChild(button4);
    document.getElementById("phylocanvas").appendChild(button5);

    document.getElementById("phylocanvas").appendChild(radio);

    function backFunc() {

       // tree.redrawFromBranch(tree.getSelectedNodeIds());
        console.log(tree.getSelectedNodeIds()[0]);
      //  tree.redrawFromBranch(tree.getSelectedNodeIds()[0]);
      //  tree.setRoot("influenza_12");
     //   tree.storeNode("influenza_12")
    }

  //  console.log(tree.branches["influenza_12"]);

   // tree.setRoot(tree.branches["influenza_03"]);
   //

    // ------------------------------------------ Geographical Map ------------------------------------------

    function geoMap(input) {

        let markers_init = {};

        for (let i = 0; i < Object.keys(input).length; i++) {

            for (let j = 0; j < Object.keys(Object.values(input)[i]).length; j++) {

                if (Object.keys(Object.values(input)[i])[j].search("lat") !== -1) {

                    markers_init[Object.keys(input)[i]] = markers_init[Object.keys(input)[i]] || {};
                    markers_init[Object.keys(input)[i]]["lat"] = input[(Object.keys(input)[i])][Object.keys(Object.values(input)[i])[j]];

                } else if (Object.keys(Object.values(input)[i])[j].search("long") !== -1) {

                    markers_init[Object.keys(input)[i]]["long"] = input[(Object.keys(input)[i])][Object.keys(Object.values(input)[i])[j]];

                }
            }
        }

        // mapid is the id of the div where the map will appear
        let map = L
            .map('mapid')
            .setView([38, 9], 5);   // center position + zoom

        // Add a tile to the map = a background. Comes from OpenStreetmap
        L.tileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
                maxZoom: 10,
            }).addTo(map);

        // Add a svg layer to the map
        L.svg().addTo(map);

        // Create data for circles:
      /*  let markers = [
            {long: 9.083, lat: 42.149}, // corsica
            {long: 7.26, lat: 43.71}, // nice
            {long: 2.349, lat: 48.864}, // Paris
            {long: -1.397, lat: 43.664}, // Hossegor
            {long: 3.075, lat: 50.640}, // Lille
            {long: -3.83, lat: 48}, // Morlaix
        ];
       */

        let markers = Object.values(input);

        // Select the svg area and add circles:
        d3.select("#mapid")
            .select("svg")
            .selectAll("myCircles")
            .data(markers)
            .enter()
            .append("circle")
            .attr("cx", function (d) {
                return map.latLngToLayerPoint([d.latitude, d.longitude]).x
            })
            .attr("cy", function (d) {
                return map.latLngToLayerPoint([d.latitude, d.longitude]).y
            })
            .attr("r", function (d) {
                return label2number("Region", markers, d.Region)*20
            })
            .style("fill", function (d) {
                return "#" + intToRGB(hashCode(d.vaccine_status))
            })
            //   .attr("stroke", "red")
            .attr("stroke-width", 3)
            .attr("fill-opacity", .3);

        // Function that update circle position if something change
        function update() {
            d3.selectAll("circle")
                .attr("cx", function (d) {
                    return map.latLngToLayerPoint([d.latitude, d.longitude]).x
                })
                .attr("cy", function (d) {
                    return map.latLngToLayerPoint([d.latitude, d.longitude]).y
                })
        }

        // If the user change the map (zoom or drag), I update circle position:
        map.on("moveend", update)

    }

    // -------------------------------------- Buttons

    let button2 = document.createElement("BUTTON");
    button2.style.zIndex = "5";
    button2.innerHTML = "hello";
    button2.style.position = "absolute";
    button2.style.right = "0";
    button2.style.top = "0";
    button2.id = "shape2";
    button2.onclick = backFunc2;

    document.getElementById("mapid").appendChild(button2);

    function backFunc2() {

        // tree.redrawFromBranch(tree.getSelectedNodeIds());
       // console.log(tree.getSelectedNodeIds()[0]);
        //  tree.redrawFromBranch(tree.getSelectedNodeIds()[0]);
        //  tree.setRoot("influenza_12");
        //   tree.storeNode("influenza_12")
    }

    // -------------------------------------- Tooltip
/*
    // create a tooltip
    let Tooltip = d3.select('#mapid')
        .append("div")
        .style("position", "absolute")
        .style("opacity", 0)
        .attr("class", "tooltip")
        .style("background-color", "white")
        .style("border", "solid")
        .style("border-width", "2px")
        .style("border-radius", "5px")
        .style("padding", "5px");

    // Three function that change the tooltip when user hover / move / leave a cell
    let mouseover = function(d) {

        Tooltip
            .style("opacity", 1);
    };

    let mousemove = function(d) {

        let number = svg_input.split("g")[1];

        if(number%2 !== 0) {
            Tooltip
                .html(d.value + " ± " + d.error)
                .style("left", (d3.mouse(this)[0] + margin.left + 15) + "px")
                .style("top", (d3.mouse(this)[1] + margin.top + 70) + "px")
        } else {
            Tooltip
                .html(d.value + " ± " + d.error)
                .style("left", (d3.mouse(this)[0] + margin.left + 775) + "px")
                .style("top", (d3.mouse(this)[1] + margin.top + 70) + "px")
        }
    };

    let mouseleave = function(d) {
        Tooltip
            .style("opacity", 0);
    };
*/

</script>

</body>

</html>